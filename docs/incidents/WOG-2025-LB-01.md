# WOG Incident Report — “Leaderboard sort + DB drift”
**ID:** WOG-2025-LB-01  
**Area:** API + DB (FastAPI, SQLAlchemy/Alembic, Postgres)  
**Status:** Resolved

## Summary
After changing the leaderboard to **sort ascending by `level`** and tweaking the **schema ordering**, the API container crashed on startup. Root cause was **DB schema drift** (models changed but migrations weren’t applied/complete) which surfaced when the new query path (ORDER BY + filters/pagination) hit columns/types/indexes that didn’t match the database. We fixed it by **regenerating and applying Alembic migrations**, rebuilding the API image, and validating the query.

## Impact
- API container failed to boot (Uvicorn exited).
- Leaderboard endpoint unavailable.
- Local dev blocked until migrations were corrected.

## What went wrong (Root cause)
1. **Model ↔ DB mismatch**  
   - We adjusted models/schemas (including leaderboard ordering logic), but the **alembic revision wasn’t correctly generated/applied**, leaving Postgres with an **old shape**.
2. **Type/ordering edge case**  
   - Sorting by `level ASC` exposed either:
     - `level` stored as `TEXT` while code assumed `INTEGER` (lexicographic vs numeric ordering), or
     - `NULL` handling changed (e.g., `NULLS FIRST`) and the query/planner hit an unexpected path (missing index / computed column).
3. **Startup validation path**  
   - On app startup or first request, ORM tried to reflect/use the changed schema and crashed (pydantic/SQLAlchemy error bubbled up; Uvicorn stopped).

## Timeline (local dev)
- T0: Change leaderboard sorting, add filters + pagination.
- T0+…: Update schemas & `meta.py`; run `docker compose up` → **API crash**.
- T0+…: Inspect logs; confirm migration mismatch.
- T0+…: Regenerate Alembic migration; **upgrade DB**; rebuild API; verify endpoint → **OK**.

## Detection
- `docker compose logs -f wog-api` showed Uvicorn exiting soon after startup with tracebacks pointing to DB/migration issues.

## Resolution (what i did)
1. **Stop & inspect**
   ```bash
   docker compose ps
   docker compose logs -f wog-api
2. Clean/rebuild (only the api to start)

    docker compose down
    docker compose build --no-cache wog-api

3. Regenerate and apply migrations

    alembic revision --autogenerate -m "sync leaderboard + level ordering"
    alembic upgrade head
    alembic current

4. Hard resync path (local only)
    docker compose down -v
docker compose up -d db
    alembic upgrade head

5. Bring stack up & verify

    docker compose up -d
    docker compose logs -f wog-api
    curl "http://localhost:8000/leaderboard?sort=level&dir=asc&page=1&page_size=20"



COMMANDS I'VE USED AND WHY:

docker compose up -d -> start in the background
docker compose down -> stop&remove
docker compose down -v -> also remove named volumes (local data reset)

build/rebuild

docker compose build wog-api
docker compose build --no-cache wog-api

status & logs

docker compose ps
docker compose logs -f wog-api

exec into a container

docker compose exec wog-api bash

one-off run (migrations without attaching)

docker compose run --rm wog-api alembic upgrade head

ALEMBIC QUICK REFERENCE:

alembic revision --autogenerate -m "message" -> create migration from model diffs
alembic upgrade head -> apply latest
alembic downgrade -1 -> step back one
alembic history -> list revisions
alembic current -> show current db head
alembic stamp head -> mark db as up-to-date w/o running
